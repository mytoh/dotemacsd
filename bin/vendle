#!/bin/sh
":"; exec emacs --quick --script "$0" -- "$@" # -*- mode: emacs-lisp; lexical-binding: t; -*-

(pop argv)  ; Remove the -- separator

(add-to-list 'load-path  "~/huone/projektit/emacs-vendle")
(require 'vendle)



(cl-defmethod vendle:update-package-git-async ((package vendle:<package>))
  (cl-letf ((name (vendle:package-name package))
            (path (vendle:concat-path vendle-directory (vendle:package-origin package)))
            (type (vendle:package-type package)))
    (when (and (cl-equalp 'git type)
               (not (file-symlink-p path)))
      (cl-letf* ((proc-buf (get-buffer-create (format "vendle-git-%s" (vendle:package-origin package))))
                 (proc-name (format "vendle-git-pull-%s" (vendle:package-origin package)))
                 (proc (start-process-shell-command proc-name
                                                    proc-buf
                                                    (format "git -C %s pull" path)))
                 (sentinel-cb
                  (lambda (process signal)
                    (cond
                      ((equal signal "finished\n")
                       (cl-letf ((result (with-current-buffer (process-buffer process)
                                           (buffer-substring (point-min) (point-max)))))
                         (vendle:message "updated package %s" name)
                         (cond
                           ((vendle:git-updatedp result)
                            (vendle:message "compiling package %s" name)
                            (vendle:message "result: %s" result)
                            (vendle:option-compile package path)
                            (vendle:option-build package)))
                         (kill-buffer (process-buffer process))))
                      (t
                       (message "got signal %s" signal)
                       (display-buffer (process-buffer process)))))))
        (set-process-sentinel proc sentinel-cb)
        proc))))


(cl-defun vendle-update-async ()
  (interactive)
  (cl-letf ((pkgs (seq-partition
                   vendle:*packages*
                   2)))
    (seq-each
     (lambda (ps)
       (seq-each
        #'accept-process-output
        (seq-map
         #'vendle:update-package-git-async
         ps)))
     pkgs)))

(defun main ()
  (cl-letf ((muki:vendle-directory
             (expand-file-name (file-name-as-directory "vendle")
                               user-emacs-directory)))
    (vendle:initialize muki:vendle-directory))

  (load "~/.emacs.d/init.d/layer/vendle/register/init.el")

  (pcase (car argv)
    ("update"
     (vendle-update))
    ("update-async"
     (vendle-update-async))
    ("check"
     (vendle-check))))

(main)

(kill-emacs 0)
