## -*- mode: eshell-script -*-

##(or (getenv "CDPATH")
##    (setenv "CDPATH"
##            (cl-reduce
##             (lambda (a b)
##         (cl-concatenate 'string
##         (expand-file-name a) ":" (expand-file-name b)))
##      '("~/huone" "~"  "/usr/local"))))

(setenv "PAGER" "cat")
(setenv "TERM" "xterm-256color")

## 補完時に大文字小文字を区別しない
(setq eshell-cmpl-ignore-case t)
## 確認なしでヒストリ保存
(setq eshell-ask-to-save-history (quote always))
## 補完時にサイクルする
(setq eshell-cmpl-cycle-completions t)
## 補完候補がこの数値以下だとサイクルせずに候補表示
(setq eshell-cmpl-cycle-cutoff-length 5)
                                        # 履歴で重複を無視する
(setq eshell-hist-ignoredups t)
## scroll to the bottom
(setq eshell-scroll-to-bottom-on-output t)
(setq eshell-scroll-show-maximum-output t)
## glob
(setq eshell-glob-case-insensitive t)
## history
(setq eshell-history-size 100000)

## run ls after cd
(setq eshell-list-files-after-cd t)

## helm
(define-key eshell-mode-map
    (kbd "C-l") 'helm-eshell-history)

## helm complete
(define-key eshell-mode-map
    [remap eshell-pcomplete]  'helm-esh-pcomplete)
(define-key eshell-mode-map (kbd "C-p") 'eshell-previous-matching-input-from-input)
(define-key eshell-mode-map (kbd "C-n") 'eshell-next-matching-input-from-input)
(liby 'evil
  (evil-define-key 'normal eshell-mode-map (kbd "C-p") 'eshell-previous-prompt)
  (evil-define-key 'normal eshell-mode-map (kbd "C-n") 'eshell-next-prompt))

## (define-key eshell-mode-map (kbd "C-r") #'eshell-previous-matching-input-from-input)
(add-to-list 'eshell-visual-commands "ssh")
(add-to-list 'eshell-visual-commands "tail")
(add-to-list 'eshell-visual-commands "lv")
(add-to-list 'eshell-command-completions-alist
             `("unarchive.sh" . ,(concat (regexp-opt '(".tar" ".tgz" ".tar.gz" ".txz" ".tar.xz" ".cbz" ".cbr" ".cbx"
                                                       ".rar" ".zip" ".7z"))
                                         "\\'")))
(add-to-list 'eshell-output-filter-functions 'eshell-handle-ansi-color)
(add-to-list 'eshell-output-filter-functions 'eshell-truncate-buffer)
(add-to-list 'eshell-output-filter-functions 'eshell-postoutput-scroll-to-bottom)

## ls colors
                                        #(set-face-attribute 'eshell-ls-directory nil  :foreground "#83a598")
                                        #(set-face-attribute 'eshell-ls-symlink   nil :foreground "#8ec07c")
                                        #(set-face-attribute 'eshell-ls-executable nil :foreground "#b8bb26")
                                        #(set-face-attribute 'eshell-ls-readonly  nil :foreground "#d3869b")
                                        #(set-face-attribute 'eshell-ls-unreadable nil :foreground "#665c54")
                                        #(set-face-attribute 'eshell-ls-special   nil :foreground "#fe8019")
                                        #(set-face-attribute 'eshell-ls-missing   nil :foreground "#fb4934")

(defun pcomplete/sudo ()
  (let ((prec (pcomplete-arg 'last -1)))
    (cond ((string= "sudo" prec)
           (while (pcomplete-here*
                   (funcall pcomplete-command-completion-function)
                   (pcomplete-arg 'last) t))))))

(defun pcomplete/please ()
  (let ((prec (pcomplete-arg 'last -1)))
    (cond ((string= "please" prec)
           (while (pcomplete-here*
                   (funcall pcomplete-command-completion-function)
                   (pcomplete-arg 'last) t))))))

(cl-defun muki:eshell-add-alias (name def)
  (add-to-list 'eshell-command-aliases-list (list name def)))

(muki:eshell-add-alias  "img" "propertize \"Image\" (quote display) ${create-image ${expand-file-name $1}}")
(muki:eshell-add-alias  "k" "killall -9 $*")
(muki:eshell-add-alias  "d" "dired-other-window ${pwd}")
(muki:eshell-add-alias  "ff" "find-file $1")
(muki:eshell-add-alias  "ll" "ls -l")
(muki:eshell-add-alias  "la" "ls -a")
(muki:eshell-add-alias  "tk" "talikko $*")
(muki:eshell-add-alias  "futaba" "pikkukivi futaba $*")
(muki:eshell-add-alias  "yotsuba" "pikkukivi yotsuba $*")
(muki:eshell-add-alias  "ylilauta" "pikkukivi ylilauta $*")
(muki:eshell-add-alias  "," "napa $*")
(muki:eshell-add-alias  "ag" "ag --nopager")
(muki:eshell-add-alias  "pam" "rm -rf $*")
(muki:eshell-add-alias  "ke" "save-buffers-kill-emacs")
(muki:eshell-add-alias  "cde" "cd ~/huone/git/git.savannah.gnu.org/emacs.git")
(muki:eshell-add-alias  "gpl" "git pull --verbose")
(muki:eshell-add-alias  "gst" "git status")
(muki:eshell-add-alias  "kuva" "pikkukivi kuva $1")
(muki:eshell-add-alias  "vittu" "pikkukivi vittu $*")
(muki:eshell-add-alias "build-emacs" "cde; gpl; gmake clean distclean; ./autogen.sh && ./configure --prefix=/home/mytoh/huone/ohjelmat/emacs --disable-acl --with-sound=oss --with-x-toolkit=gtk3 --with-file-notification=gfile --enable-link-time-optimization --enable-silent-rules CC=clang-devel CPP=clang-cpp-devel CXX=clang++-devel MAKE=gmake && gmake && gmake install; gmake clean distclean")
(muki:eshell-add-alias "build-emacs-bootstrap" "cde; gpl; gmake clean distclean; ./autogen.sh && ./configure --prefix=/home/mytoh/huone/ohjelmat/emacs --disable-acl --with-sound=oss --with-x-toolkit=gtk3 --with-file-notification=gfile --enable-link-time-optimization --enable-silent-rules CC=clang-devel CPP=clang-cpp-devel CXX=clang++-devel MAKE=gmake && gmake bootstrap && gmake && gmake install; gmake clean distclean")
(muki:eshell-add-alias "build-gauche" "cd /home/mytoh/huone/git/github.com/shirok/Gauche && git pull ; ./DIST gen ; cd ~/huone/satunnainen ; rm -rf gauche-build ; mkdir -pv gauche-build && cd gauche-build && ~/huone/git/github.com/shirok/Gauche/configure --prefix=/home/mytoh/huone/ohjelmat/gauche --enable-tls=axtls --with-local=/usr/local --enable-ipv6 CC=clang-devel CPP=clang-cpp-devel CXX=clang++-devel && gmake all install && rm -rf ~/huone/satunnainen/gauche-build")
(muki:eshell-add-alias "build-fish" "cd ~/huone/git/github.com/fish-shell/fish-shell ; git pull ; gmake clean distclean ; autoconf ; ./configure --prefix=/home/mytoh/huone/ohjelmat/fish LDFLAGS=-L/usr/local/lib CPPFLAGS=-I/usr/local/include CC=clang-devel CXX=clang++-devel CPP=clang-cpp-devel --with-doxygen ; gmake ; gmake install")

(when (string-equal system-type "berkeley-unix")
  (muki:eshell-add-alias "pcheck" "sudo portmaster -PBiydav && sudo portaudit -Fdav && sudo portmaster --clean-packages --clean-distfiles" )
  (muki:eshell-add-alias "pfetch" "sudo make fetch-recursive" )
  (muki:eshell-add-alias "pinst" "sudo make -s clean reinstall clean distclean")
  (muki:eshell-add-alias "pconf" "sudo make config")
  (muki:eshell-add-alias "pconfr" "sudo make config-recursive")
  (muki:eshell-add-alias "pclean" "sudo make clean "         )
  (muki:eshell-add-alias "ppconf" "make pretty-print-config" )
  (muki:eshell-add-alias "psconf" "make showconfig"          )
  (muki:eshell-add-alias "prmconf" "make rmconfig"           )
  (muki:eshell-add-alias "puniname" "make -VUNIQUENAME"      ))
